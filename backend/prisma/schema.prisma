generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model GuildConfig {
  id                    String   @id @default(cuid())
  guildId               String   @unique
  ticketCategoryId      String?
  logChannelId          String?
  transcriptChannelId   String?
  supportRoleId         String?
  enableQuickResponses  Boolean  @default(true)
  enableRating          Boolean  @default(true)
  enableTranscripts     Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tickets               Ticket[]
  menus                 Menu[]
  messages              Message[]
  webhooks              Webhook[]

  @@map("guild_configs")
}

model Menu {
  id          String      @id @default(cuid())
  guildId     String
  name        String
  description String?
  channelId   String?
  messageId   String?
  enabled     Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  guild       GuildConfig @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  buttons     MenuButton[]

  @@map("menus")
}

model MenuButton {
  id          String   @id @default(cuid())
  menuId      String
  label       String
  emoji       String?
  style       String   @default("Primary") // Primary, Secondary, Success, Danger
  categoryId  String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@map("menu_buttons")
}

model Message {
  id          String      @id @default(cuid())
  guildId     String
  key         String      // welcome_message, ticket_created, ticket_closed, etc.
  content     String      @db.Text
  ephemeral   Boolean     @default(false)
  embedTitle  String?
  embedDesc   String?     @db.Text
  embedColor  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  guild       GuildConfig @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@unique([guildId, key])
  @@map("messages")
}

model Ticket {
  id              String       @id @default(cuid())
  guildId         String
  channelId       String       @unique
  userId          String
  assignedUserId  String?
  categoryName    String?
  status          TicketStatus @default(OPEN)
  closedAt        DateTime?
  closedBy        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  guild           GuildConfig  @relation(fields: [guildId], references: [guildId], onDelete: Cascade)
  responses       QuickResponse[]
  rating          Rating?
  logs            Log[]

  @@map("tickets")
}

enum TicketStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model QuickResponse {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  wasHelpful  Boolean
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("quick_responses")
}

model Rating {
  id          String   @id @default(cuid())
  ticketId    String   @unique
  userId      String
  stars       Int      // 1-5
  feedback    String?  @db.Text
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ratings")
}

model Log {
  id          String   @id @default(cuid())
  guildId     String
  ticketId    String?
  userId      String?
  action      String   // ticket_created, ticket_closed, message_sent, etc.
  details     String?  @db.Text
  createdAt   DateTime @default(now())

  ticket      Ticket?  @relation(fields: [ticketId], references: [id], onDelete: SetNull)

  @@map("logs")
}

model Webhook {
  id          String      @id @default(cuid())
  guildId     String
  name        String
  url         String
  secret      String?
  events      String[]    // ticket_created, ticket_closed, etc.
  enabled     Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  guild       GuildConfig @relation(fields: [guildId], references: [guildId], onDelete: Cascade)

  @@map("webhooks")
}
